name: Process data

on: [push, pull_request]

jobs:
  compile-pdf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.8
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
      
      - name: Create temporary output folder
        run: "rm -Rf ./output; mkdir ./output"

      - name: Install markdown-to-pdf
        run: "npm install --prefix . md-to-pdf"
      
      - name: Compile PDF exam
        run: "node node_modules/md-to-pdf/dist/cli.js --body-class 'markdown-body' --css '.page-break { page-break-after: always; } .markdown-body { font-size: 10px; } .markdown-body pre > code { white-space: pre-wrap; }' --stylesheet 'https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css' ./src/PE1.md"
      
      - name: Create student folder
        run: "python ./pkg/make-student-zip.py output/ZoomRooms src ZoomRooms.java"
      
      - name: Copy exam to folder
        run: "mv -v ./src/PE1.pdf ./output/ZoomRooms/exam.pdf"
      
      - run: "rsync --archive --quiet --exclude 'runConfigurations' --exclude '*.save' --exclude '.name' './pkg/template/.idea/' './output/ZoomRooms/.idea/'"
      - run: "rsync --archive --quiet './pkg/template/.lift/' './output/ZoomRooms/.lift/'"
      - run: "cp -vpr ./pkg/template/LIFT.iml ./output/ZoomRooms/ZoomRooms.iml"
      
      - name: ZIP folder
        run: "rm -vRf ./PE1.zip; pushd ./output; ls -alht ZoomRooms; tree -a ZoomRooms; zip -vr PE1.zip ./ZoomRooms; popd; mv -v output/PE1.zip ./"
      
      - name: Commit compiled PDF
        uses: EndBug/add-and-commit@v4
        with:
          message: "Commit compiled ZIP"
          add: "PE1.zip"
          cwd: "."
          force: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
